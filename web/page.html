<!-- The main function of my C++ code is executed at the beginning after importing this js file, which also exposes the Module object -->
<script src="./js/yokai-lib.js"></script>
<script src="./js/yokai-api.js"></script>
<script language="javascript">
    var selectedPos;
    var game;
    var difficulty;
    var history;

    function init(d) {
        selectedPos = -1;
        game = Yokai.Default();
        difficulty = d;
        history = new GameHistory()
        // history.game += game;
        draw();
    }
    init(5);

    function writeHtml() {
        W = 100
        black = "#000";
        white = "#fff";
        b = "";
        b += "<button onclick=init(3)>Easy</button>";
        b += "<button onclick=init(5)>Medium</button>";
        b += "<button onclick=init(6)>Hard</button>";
        b += "<div>Difficulty : <span id=difficulty></span></div>"; 
        b += "Rules : "
        b += "<div> <table cellspacing=0 align=center>";
        for(i = 0; i < 7; ++i) {
            b += "<th width="+W+" height="+W+" onclick=C('r',"+i+",1)" +
                    " style='border:2px solid #999' id=r"+i+1+
                    " bgcolor=#"+(i&1?"aaaaaa>":"eeeeee>");
        }
        b += "</tr> </table> </div>";
        b += "<div><table cellspacing=0 align=center border: 3px solid black;>";
        for(i = 0; i < 4; ++i) {
            for(j = 0; j < 3; ++j) {
                b += "<th width="+W+" height="+W+" onclick=C('b',"+i+","+j+")" +
                     " style='border:2px solid #999' id=b"+i+j +
                     " bgcolor=#"+((3*i+j)&1?"aaaaaa>":"eeeeee>");
            }
            b += "</tr>";
        }
        b += "</table> </div>";
        b += "<div> <table cellspacing=0 align=center>";
        for(i = 0; i < 7; ++i) {
            b += "<th width="+W+" height="+W+" onclick=C('r',"+i+",0)" +
                    " style='border:2px solid #999' id=r"+i+0+
                    " bgcolor=#"+(i&1?"aaaaaa>":"eeeeee>");
        }
        b += "</tr> </table> </div>";
        document.write(b);
    }
    writeHtml();

    function C(part, i, j) {
        if(selectedPos == -1) {
            selectedPos = part+i+j;
        } else {
            if(selectedPos[0] == 'b' && part == 'b') {
                i0 = parseInt(selectedPos[1]);
                j0 = parseInt(selectedPos[2]);
                p = 3*i0+j0;
                game.play("move", game.board[p], p, 3*i+j);
            } else if(selectedPos[0] == 'r' && selectedPos[2] == '0' && part == 'b'){
                i0 = parseInt(selectedPos[1]);
                p = i0;
                game.play("drop", game.reserve0[p], p, 3*i+j);
            }
            draw();
            if(game.winner() != -1) {
                alert("Player : " + game.winner() + " has won !");
                d = difficulty;
                init(d);
                draw();
            }
            selectedPos = -1;
            if(game.currentPlayer == 1) {
                game.autoPlay(difficulty);
                draw();
                if(game.winner() != -1) {
                    alert("Player " + game.winner() + " has won !");
                    d = difficulty;
                    init(d);
                    draw();
                }
            }
        }
        draw();
    }

    function draw() {
        W = 100
        path = "img/own/";
        ext = ".png"
        black = "#000";
        white = "#fff";
        if(q = document.getElementById("difficulty")) {
            q.innerHTML = (difficulty == 3 ? 'Easy' : (difficulty == 5 ? 'Medium' : 'Hard'));
        }
        for(i = 0; i < 4; ++i) {
            for(j = 0; j < 3; ++j) {
                id = "b"+i+j;
                if (q = document.getElementById(id)) {
                    p = 3*i+j;
                    charCode = game.board[3*i+j];
                    if(charCode === '.') charCode = 'e';
                    q.innerHTML = "<img width="+W+" src="+path + charCode + ext+">";
                    q.style.borderColor = id == selectedPos ? black : white;
                }
            }
        }
        for(i = 0; i < 7; ++i) {
            id = "r"+i+0;
            if (q = document.getElementById(id)) {
                charCode = (i < game.reserve0.length ? game.reserve0[i] : 'e');
                if(charCode === '.') charCode = 'e';
                q.innerHTML = "<img width="+W+" src="+path + charCode + ext+">";
                q.style.borderColor = id == selectedPos ? black : white;
            }
        }
        for(i = 0; i < 7; ++i) {
            id = "r"+i+1;
            if (q = document.getElementById(id)) {
                charCode = (i < game.reserve1.length ? game.reserve1[i] : 'e');
                if(charCode === '.') charCode = 'e';
                q.innerHTML = "<img width="+W+" src="+path + charCode + ext+">";
                q.style.borderColor = id == selectedPos ? black : white;
            }
        }
    }
    draw();

</script>